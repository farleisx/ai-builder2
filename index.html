<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Website Builder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;700&family=Inter:wght@400;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #0b0c10;
            color: #c5c6c7;
            overflow: hidden;
        }

        .chat-container {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            height: calc(100vh - 120px);
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #66fcf1 #1f2833;
        }
        .chat-container::-webkit-scrollbar {
            width: 8px;
        }
        .chat-container::-webkit-scrollbar-track {
            background: #1f2833;
        }
        .chat-container::-webkit-scrollbar-thumb {
            background-color: #66fcf1;
            border-radius: 20px;
        }

        .message {
            max-width: 85%;
            padding: 10px 15px;
            border-radius: 20px;
            margin-bottom: 15px;
            line-height: 1.5;
            word-wrap: break-word;
        }

        .user-message {
            background-color: #45a29e;
            color: #0b0c10;
            align-self: flex-end;
            border-bottom-right-radius: 0;
        }

        .ai-message {
            background-color: #1f2833;
            color: #c5c6c7;
            align-self: flex-start;
            border-bottom-left-radius: 0;
            position: relative;
        }

        .code-editor {
            font-family: 'Fira Code', monospace;
            background-color: #1f2833;
            color: #c5c6c7;
            border: 2px solid #45a29e;
            resize: none;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #66fcf1;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="flex flex-col md:flex-row h-screen p-4">

    <!-- Left Panel: Chat Interface -->
    <div class="flex-1 flex flex-col bg-[#11161d] rounded-2xl shadow-lg p-6 mr-0 md:mr-4 mb-4 md:mb-0">
        <h1 class="text-3xl font-bold mb-6 text-center text-[#66fcf1]">AI Website Agent</h1>
        <div id="chat-history" class="chat-container flex flex-col mb-4">
            <div class="ai-message self-start text-sm">Hello! I am your AI web development agent. How can I help you build a website today?</div>
        </div>
        <div class="flex">
            <input type="text" id="user-prompt" placeholder="Describe your website idea..." class="flex-1 p-3 rounded-l-xl bg-[#1f2833] text-white focus:outline-none focus:ring-2 focus:ring-[#45a29e]">
            <button id="send-button" class="bg-[#66fcf1] text-[#0b0c10] px-6 py-3 rounded-r-xl font-bold transition-transform transform hover:scale-105">
                <span id="send-text">Send</span>
                <div id="spinner" class="spinner hidden"></div>
            </button>
        </div>
    </div>

    <!-- Right Panel: Live Preview & Code Editor -->
    <div class="flex-1 flex flex-col bg-[#11161d] rounded-2xl shadow-lg p-6">
        <div class="flex-1 mb-4 flex flex-col">
            <h2 class="text-xl font-bold mb-2 text-center text-[#66fcf1]">Live Preview</h2>
            <iframe id="live-preview" class="flex-1 bg-white border-2 border-[#45a29e] rounded-xl mb-4"></iframe>
            <h2 class="text-xl font-bold mb-2 text-center text-[#66fcf1]">Generated Code</h2>
            <textarea id="code-output" class="code-editor flex-1 p-4 rounded-xl text-sm leading-relaxed" readonly></textarea>
        </div>
    </div>

    <script>
        const userPromptInput = document.getElementById('user-prompt');
        const sendButton = document.getElementById('send-button');
        const sendText = document.getElementById('send-text');
        const spinner = document.getElementById('spinner');
        const chatHistoryDiv = document.getElementById('chat-history');
        const codeOutputTextarea = document.getElementById('code-output');
        const livePreviewFrame = document.getElementById('live-preview');

        let chatHistory = [{
            role: "user",
            parts: [{ text: "I want you to act as a world-class web developer. Your task is to generate complete, single-file HTML websites based on user requests. The code should be fully self-contained, including all necessary CSS and JavaScript within <style> and <script> tags. Use modern, clean design principles and ensure the website is fully mobile-responsive. The website should look and function professionally. Respond with ONLY the complete HTML code, nothing else." }]
        }];

        const createMessage = (text, sender) => {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', sender === 'user' ? 'user-message' : 'ai-message');
            messageDiv.textContent = text;
            chatHistoryDiv.appendChild(messageDiv);
            chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;
        };

        const generateCode = async () => {
            const userMessage = userPromptInput.value.trim();
            if (!userMessage) return;

            createMessage(userMessage, 'user');
            userPromptInput.value = '';

            // Add user message to history
            chatHistory.push({ role: "user", parts: [{ text: userMessage }] });

            sendButton.disabled = true;
            sendText.classList.add('hidden');
            spinner.classList.remove('hidden');

            try {
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ chatHistory: chatHistory })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Server error occurred.');
                }

                const result = await response.json();
                const generatedCode = result.code;
                
                // Add AI message to history
                chatHistory.push({ role: "model", parts: [{ text: generatedCode }] });
                
                // Update code editor and live preview
                codeOutputTextarea.value = generatedCode;
                livePreviewFrame.srcdoc = generatedCode;
                
                createMessage("Here is the website I generated for you. You can continue to chat with me to modify it.", 'ai');
            
            } catch (error) {
                console.error("Fetch error:", error);
                createMessage(`Error: ${error.message}. Please try again.`, 'ai');
            } finally {
                sendButton.disabled = false;
                sendText.classList.remove('hidden');
                spinner.classList.add('hidden');
            }
        };

        sendButton.addEventListener('click', generateCode);
        userPromptInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                generateCode();
            }
        });
    </script>
</body>
</html>
